---
title: "Digital Divide"
author: "Meg Raisle"
date: "4/27/2021"
output: html_document
---

```{r setup, include=FALSE, error=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=TRUE)
library(glptools)
glp_load_packages()
library(arrow)
library(labelled)
```

## This document reads in and processes both Census and IPUMUS Microdata to pull variables related to digital divide
### This includes information on internet access (normal, highspeed, etc) and device access. These questions have been included in the ACS since 2013.

### First we're going to work with Census Data 
This calls in all of the relevant variables. A bit of context about each table is included below, also. 
```{r Census_ACS_Variables, eval=FALSE}
#B28002 - internet access at household level
#this details what type of internet subscription people have, if they have internet
#access without a subscription, or if they have no internet access.
#this corresponds with CINETHH, CIHISPEED, and CIDIAL in IPUMS
internet_household   <- build_census_var_df("acs5", "B28002")

#B28001 - computer in household
compdevice_household   <- build_census_var_df("acs5", "B28001")

#B28003 - computer and internet access at houeshold level
#Details if they have internet subscription (and what type) or not with a computer
#or if they have no computer
compinternet_household   <- build_census_var_df("acs5", "B28003")

#b28004 - internet presence and type by income
incomeinternet_household <- build_census_var_df("acs5", "B28004")

#b28005 - age by computer and internet - individual
ageinternetcomp_individual <- build_census_var_df("acs5", "B28005")

#b28006 - computer and internet by education
eduinternetcomp_individual <- build_census_var_df("acs5", "B28006")

#b28009 - computer and internet by race
raceinternetcomp_individual <- build_census_var_df("acs5", "B28009")
```

Next we're going to work with the age table - pull down the data, remove total columns, and process it to make map files :

```{r Process_Census, eval=FALSE}

age <- get_census(ageinternetcomp_individual, "tract")

#clear out totals
totals <- c("B28005_001E","B28005_001M","B28005_002E",
            "B28005_008E", "B28005_014E","B28005_002M",
            "B28005_008M", "B28005_014M",
            "B28005_009E", "B28005_015E", "B28005_003E", "B28005_009M", "B28005_015M", "B28005_003M")

age_nototal <- age %>%
  subset(variable %not_in% totals)

#make categorical variable
age_nototal  %<>% mutate(compinternet = if_else(str_detect(label,"broadband Internet subscription"), T, F))

#process census
clean_age <- age_nototal %>%
  process_census(cat_var = "compinternet",
                 output_name = "access", age_groups = c("under_18", "18_64", "65_plus"))

#process map
map_age <- clean_age%>%
  process_map(access_under_18, access_18_64, access_65_plus,return_name = "access_by_age") %>%
  list2env(.GlobalEnv)
```

### Now we're going to work with the IPUMS Microdata
The data we're calling in here has already been run through microdata.rmd
```{r Microdata_variables, eval=FALSE}

#read data - change this to wherever this is stored locally on your computer
acs_micro <- feather::read_feather("/Users/mraisle/Documents/OneDrive - University of North Carolina at Chapel Hill/glpdata/data-raw/microdata/acs_micro_repwts.feather")

#make logical variables for the metrics we care about
#the method i took here is a bit long winded .  . . case_when worked best to get the binary
#that I wanted for some variables but T,F was how I wanted it evaluated for survey_by_demog, hence this approach
acs_micro_internet <- acs_micro %>%
  filter(year > 2012) %>%
  mutate(
    MSA = as.character(MSA),
    int_acc = if_else(CINETHH == 1 | CINETHH == 2, T, F),
    int_acc = replace(int_acc, CINETHH == 0, NA),

    hspd_int = case_when(
        CINETHH == 0 ~ NA_real_,
        CINETHH == 3 & CIHISPEED == 0 ~ 0, #seems like it's marked NA if the household doesn't have internet access. We want it to be no High Speed access
        CIHISPEED > 9 & CIHISPEED < 20 ~ 1,
        CIHISPEED == 20 ~ 0
      ),
    computer = if_else(CILAPTOP == 1, T, F),
    computer = replace(computer, CILAPTOP == 0, NA),

    tablet = if_else(CITABLET == 1, T, F),
    tablet = replace(tablet, CITABLET == 0, NA),

    smrtphone = if_else(CISMRTPHN == 1, T, F),
    smrtphone = replace(smrtphone, CISMRTPHN == 0, NA),

    #ok so below is if someone has a computer or tablet at home
    comp_tab = case_when(
      computer == 1 | tablet == 1 ~ 1,
      computer == 0 & tablet == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    #ok so below is if someone has a computer,tablet, or smartphone
    comp_tab_smrt = case_when(
      computer == 1 | tablet == 1 | smrtphone == 1 ~ 1,
      computer == 0 & tablet == 0 & smrtphone == 0 ~ 0,
      TRUE ~ NA_real_),
    #this is seeing if someone has a computer or tablet and high speed internet
    internet_and_device = case_when(
      comp_tab == 1 & hspd_int == 1 ~ 1,
      comp_tab == 0 | hspd_int == 0 ~ 0,
      TRUE ~ NA_real_),
  )

#convert necessary ones to true false
acs_micro_internet$internet_and_device %<>%
  as.logical(acs_micro_internet$internet_and_device)
acs_micro_internet$comp_tab_smrt %<>%
  as.logical(acs_micro_internet$comp_tab_smrt)
acs_micro_internet$comp_tab %<>%
  as.logical(acs_micro_internet$comp_tab)
acs_micro_internet$hspd_int %<>%
  as.logical(acs_micro_internet$hspd_int)

```

Now we're going to process this using survey by demographic, make dataframes for county and MSA level, and merge all the variables back into one dataframe for saving. 

```{r Microdata_Processing, eval=FALSE}

#internet access
internetaccess_county  <- survey_by_demog(acs_micro_internet, "int_acc")
internetaccess_MSA5yr  <- survey_by_demog(acs_micro_internet, "int_acc",geog = "MSA")
#high speed internet access
hispdaccess_county  <- survey_by_demog(acs_micro_internet, "hspd_int")
hispdaccess_MSA5yr  <- survey_by_demog(acs_micro_internet, "hspd_int",geog = "MSA")
#computer or tablet access
comptab_county  <- survey_by_demog(acs_micro_internet, "comp_tab")
comptab_MSA5yr  <- survey_by_demog(acs_micro_internet, "comp_tab",geog = "MSA")
#computer, smartphone, or tablet access
comptabsmrt_county  <- survey_by_demog(acs_micro_internet, "comp_tab_smrt")
comptabsmrt_MSA5yr  <- survey_by_demog(acs_micro_internet, "comp_tab_smrt",geog = "MSA")
#internet_and_device
internetanddevice_county  <- survey_by_demog(acs_micro_internet, "internet_and_device")
internetanddevice_MSA5yr  <- survey_by_demog(acs_micro_internet, "internet_and_device", geog = "MSA")

#merge all county together:
mergeCols <- c("FIPS","year","sex","race","var_type")

digitalaccess_county <- inner_join(internetaccess_county, hispdaccess_county,
                           by = mergeCols)
digitalaccess_county %<>% inner_join(comptab_county,
                                   by = mergeCols)
digitalaccess_county %<>% inner_join(comptabsmrt_county,
                                     by = mergeCols)
digitalaccess_county %<>% inner_join(internetanddevice_county,
                                     by = mergeCols)

percentdigitalaccess_county <- digitalaccess_county %>% 
  filter(var_type=="percent") %>% mutate(
  var_type = NULL)
#merge all MSA together:
MSACols <- c("MSA","year","sex","race","var_type")

digitalaccess_MSA5yr <- inner_join(internetaccess_MSA5yr, hispdaccess_MSA5yr,
                                   by = MSACols)
digitalaccess_MSA5yr %<>% inner_join(comptab_MSA5yr,
                                     by = MSACols)
digitalaccess_MSA5yr %<>% inner_join(comptabsmrt_MSA5yr,
                                     by = MSACols)
digitalaccess_MSA5yr %<>% inner_join(internetanddevice_MSA5yr,
                                     by = MSACols)

```

Finally, we're going to save all of these files to glpdata

``` {r Saving_Data, eval=FALSE}
#need to rename the map files to make more clear
usethis::use_data(digitalaccess_county, percentdigitalaccess_county, digitalaccess_MSA5yr, access_by_age_muw, access_by_age_nh, access_by_age_tract, overwrite = TRUE)

```
